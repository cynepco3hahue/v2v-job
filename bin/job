#!/bin/bash

SRCD=${1:-/v2v-src}
DSTD=${2:-/v2v-dst}

mkdir -p $SRCD $DSTD

pwd

die() { echo $@ >&2 ; exit 1 ; }

for SRCTYPEFILE in $(ls $SRCD/*);
do
  SRCTYPE=$(basename $SRCTYPEFILE)
  echo "Found source type: $SRCTYPE"
  for SRC in $(cat $SRCTYPEFILE);
  do
    echo "  Converting source: $SRC"
    WD="$(basename $SRC).d"
    mkdir -p $WD

    virt-v2v -i "$SRCTYPE" "$SRC" -o local -oa sparse -of raw -os $WD --machine-readable
    # generate disk and domxml
    DOMXML=$(ls $WD/*.xml)
    VMYAML=${DOMXML%.xml}.yaml

    # Generate vm.yaml
    xsltproc ../data/toVMSpec.xsl $DOMXML | tee $VMYAML

    if [[ $(xmllint --xpath "count(//disk[@type='file']/source)" $DOMXML) -gt 1 ]];
    then
      die "Only one disk per VM is supported ATM"
    fi

    DISKFILE=$(xmllint --xpath "string(//disk[@type='file']/source/@file)" $DOMXML)
    echo cp -v $DISKFILE $DSTD/disk.raw
    echo kubectl apply -f $VMYAML
  done
done
